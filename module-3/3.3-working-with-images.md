# 3.3 Working with Container Images in ACR

## Overview
This lab provides hands-on experience with pushing, pulling, and managing container images in Azure Container Registry. You'll learn the complete image lifecycle including tagging strategies, repository management, and security configurations.

## Learning Objectives
- Authenticate to ACR from Docker CLI
- Tag container images for ACR
- Push images to ACR repositories
- List and inspect repositories and tags
- Pull images from ACR
- Run containers from ACR images
- Manage image lifecycle (delete, purge)
- Configure content trust for image signing

## Prerequisites
- Azure Container Registry created (Lab 3.2)
- Docker installed and running locally
- Azure CLI configured (Lab 3.1)
- A .NET container image built locally (from Module 2)
- Basic understanding of Docker commands

---

## Lab 1: Authenticating to ACR

### Step 1: Login Using Azure CLI (Recommended)

```bash
# Set ACR name variable
ACR_NAME="progressacr12345678"  # Replace with your ACR name

# Login to ACR using Azure AD authentication
az acr login --name $ACR_NAME
```

**Expected Output:**
```
Login Succeeded
```

**How it works:**
- Uses your Azure AD credentials
- Token valid for 3 hours
- Most secure method for interactive use
- No need for admin credentials

### Step 2: Verify Docker Configuration

```bash
# Check Docker credentials helper
cat ~/.docker/config.json

# Verify Docker can connect
docker info | grep Registry
```

**Expected Output:**
```json
{
  "auths": {
    "progressacr12345678.azurecr.io": {}
  },
  "credHelpers": {
    "progressacr12345678.azurecr.io": "desktop"
  }
}
```

### Step 3: Alternative Authentication Methods

#### Option A: Using Admin Credentials (Development Only)

```bash
# Enable admin user
az acr update --name $ACR_NAME --admin-enabled true

# Get credentials
ACR_USERNAME=$(az acr credential show --name $ACR_NAME --query "username" --output tsv)
ACR_PASSWORD=$(az acr credential show --name $ACR_NAME --query "passwords[0].value" --output tsv)

# Login with credentials
docker login $ACR_NAME.azurecr.io --username $ACR_USERNAME --password $ACR_PASSWORD
```

**⚠️ Security Warning:** Only use admin credentials for testing. Production should use service principals or managed identities.

#### Option B: Using Service Principal

```bash
# Create service principal (you'll learn more in Lab 3.5)
SP_NAME="acr-push-pull-sp"
ACR_REGISTRY_ID=$(az acr show --name $ACR_NAME --query id --output tsv)

# Create service principal with acrpush role
SP_PASSWD=$(az ad sp create-for-rbac \
  --name $SP_NAME \
  --scopes $ACR_REGISTRY_ID \
  --role acrpush \
  --query password \
  --output tsv)

SP_APP_ID=$(az ad sp list --display-name $SP_NAME --query [].appId --output tsv)

# Login with service principal
docker login $ACR_NAME.azurecr.io --username $SP_APP_ID --password $SP_PASSWD
```

---

## Lab 2: Tagging Images for ACR

### Understanding Image Tags

**Tag Format:** `<registry>/<repository>:<tag>`

Example: `progressacr12345678.azurecr.io/mywebapi:1.0.0`

Components:
- **Registry**: `progressacr12345678.azurecr.io`
- **Repository**: `mywebapi`
- **Tag**: `1.0.0`

### Step 1: List Local Images

```bash
# List all local Docker images
docker images

# Filter by name
docker images mywebapi
```

**Expected Output:**
```
REPOSITORY   TAG       IMAGE ID       CREATED          SIZE
mywebapi     1.0       abc123def456   10 minutes ago   220MB
mywebapi     latest    abc123def456   10 minutes ago   220MB
```

### Step 2: Tag Image for ACR

```bash
# Set environment variables
ACR_NAME="progressacr12345678"
ACR_LOGIN_SERVER="$ACR_NAME.azurecr.io"
IMAGE_NAME="mywebapi"
VERSION="1.0.0"

# Tag with version
docker tag $IMAGE_NAME:latest $ACR_LOGIN_SERVER/$IMAGE_NAME:$VERSION

# Tag as latest
docker tag $IMAGE_NAME:latest $ACR_LOGIN_SERVER/$IMAGE_NAME:latest

# Tag with build number (CI/CD scenario)
BUILD_NUMBER="build-123"
docker tag $IMAGE_NAME:latest $ACR_LOGIN_SERVER/$IMAGE_NAME:$BUILD_NUMBER

# Verify tags created
docker images $ACR_LOGIN_SERVER/$IMAGE_NAME
```

**Expected Output:**
```
REPOSITORY                                    TAG         IMAGE ID       CREATED          SIZE
progressacr12345678.azurecr.io/mywebapi       1.0.0       abc123def456   10 minutes ago   220MB
progressacr12345678.azurecr.io/mywebapi       latest      abc123def456   10 minutes ago   220MB
progressacr12345678.azurecr.io/mywebapi       build-123   abc123def456   10 minutes ago   220MB
```

### Step 3: Tagging Best Practices

```bash
# Semantic versioning
docker tag mywebapi:latest $ACR_LOGIN_SERVER/mywebapi:1.0.0
docker tag mywebapi:latest $ACR_LOGIN_SERVER/mywebapi:1.0
docker tag mywebapi:latest $ACR_LOGIN_SERVER/mywebapi:1

# Environment-specific tags
docker tag mywebapi:latest $ACR_LOGIN_SERVER/mywebapi:dev
docker tag mywebapi:latest $ACR_LOGIN_SERVER/mywebapi:staging
docker tag mywebapi:latest $ACR_LOGIN_SERVER/mywebapi:prod-v1.0.0

# Git commit SHA
GIT_SHA=$(git rev-parse --short HEAD)
docker tag mywebapi:latest $ACR_LOGIN_SERVER/mywebapi:$GIT_SHA

# Timestamp tag
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
docker tag mywebapi:latest $ACR_LOGIN_SERVER/mywebapi:$TIMESTAMP
```

---

## Lab 3: Pushing Images to ACR

### Step 1: Push Single Image

```bash
# Login to ACR
az acr login --name $ACR_NAME

# Push specific tag
docker push $ACR_LOGIN_SERVER/mywebapi:1.0.0
```

**Expected Output:**
```
The push refers to repository [progressacr12345678.azurecr.io/mywebapi]
5f70bf18a086: Pushed 
d82a8f84b4d2: Pushed 
ac9ef462e8df: Pushed 
1.0.0: digest: sha256:abc123... size: 1576
```

### Step 2: Push Multiple Tags

```bash
# Push all tags for an image
docker push $ACR_LOGIN_SERVER/mywebapi:1.0.0
docker push $ACR_LOGIN_SERVER/mywebapi:latest
docker push $ACR_LOGIN_SERVER/mywebapi:build-123

# Or use a loop
for tag in 1.0.0 latest build-123; do
  docker push $ACR_LOGIN_SERVER/mywebapi:$tag
done
```

### Step 3: Push Multiple Images (Batch Script)

```bash
#!/bin/bash

ACR_NAME="progressacr12345678"
ACR_LOGIN_SERVER="$ACR_NAME.azurecr.io"

# Array of images to push
IMAGES=("mywebapi" "myworkerservice" "mybackgroundjob")
VERSION="1.0.0"

# Login once
az acr login --name $ACR_NAME

# Tag and push all images
for image in "${IMAGES[@]}"; do
  echo "Processing $image..."
  
  # Tag with version
  docker tag $image:latest $ACR_LOGIN_SERVER/$image:$VERSION
  docker tag $image:latest $ACR_LOGIN_SERVER/$image:latest
  
  # Push both tags
  docker push $ACR_LOGIN_SERVER/$image:$VERSION
  docker push $ACR_LOGIN_SERVER/$image:latest
  
  echo "✓ Completed $image"
done

echo "All images pushed successfully!"
```

Save as `push-images.sh` and run:

```bash
chmod +x push-images.sh
./push-images.sh
```

### Step 4: Monitor Push Progress

```bash
# View push events in real-time (separate terminal)
az acr webhook list-events --registry $ACR_NAME --name mypushhook

# Check repository after push
az acr repository list --name $ACR_NAME --output table
```

---

## Lab 4: Listing and Inspecting Repositories

### Step 1: List All Repositories

```bash
# List all repositories in ACR
az acr repository list --name $ACR_NAME --output table

# List with JSON output for scripting
az acr repository list --name $ACR_NAME --output json
```

**Expected Output:**
```
Result
----------------
mywebapi
myworkerservice
mybackgroundjob
```

### Step 2: List Tags in Repository

```bash
# Show all tags for a repository
az acr repository show-tags --name $ACR_NAME --repository mywebapi --output table

# Order by timestamp
az acr repository show-tags \
  --name $ACR_NAME \
  --repository mywebapi \
  --orderby time_desc \
  --output table
```

**Expected Output:**
```
Result
---------
1.0.0
latest
build-123
dev
```

### Step 3: Show Detailed Tag Information

```bash
# Show tag details with manifests
az acr repository show-tags \
  --name $ACR_NAME \
  --repository mywebapi \
  --detail \
  --output table
```

**Expected Output:**
```
Name      CreatedTime                   Digest
--------  ----------------------------  ------------
1.0.0     2026-01-28T10:30:00.000000Z   sha256:abc...
latest    2026-01-28T10:30:00.000000Z   sha256:abc...
build-123 2026-01-28T10:30:00.000000Z   sha256:abc...
```

### Step 4: Get Repository Metadata

```bash
# Show repository attributes
az acr repository show \
  --name $ACR_NAME \
  --repository mywebapi

# Get specific property
az acr repository show \
  --name $ACR_NAME \
  --repository mywebapi \
  --query "changeableAttributes.deleteEnabled"
```

### Step 5: Search and Filter Repositories

```bash
# List repositories with specific pattern
az acr repository list --name $ACR_NAME | grep "api"

# Count repositories
az acr repository list --name $ACR_NAME | jq 'length'

# Get total image count
az acr repository list --name $ACR_NAME --output json | \
  jq 'length' | \
  xargs -I {} echo "Total repositories: {}"
```

---

## Lab 5: Pulling Images from ACR

### Step 1: Pull Specific Tag

```bash
# Pull specific version
docker pull $ACR_LOGIN_SERVER/mywebapi:1.0.0

# Verify image pulled
docker images $ACR_LOGIN_SERVER/mywebapi
```

**Expected Output:**
```
REPOSITORY                                    TAG       IMAGE ID       CREATED       SIZE
progressacr12345678.azurecr.io/mywebapi       1.0.0     abc123def456   1 hour ago    220MB
```

### Step 2: Pull Latest Tag

```bash
# Pull latest version
docker pull $ACR_LOGIN_SERVER/mywebapi:latest

# Pull and run in one command
docker run -d -p 8080:8080 $ACR_LOGIN_SERVER/mywebapi:latest
```

### Step 3: Pull to Different Local Tag

```bash
# Pull and retag locally
docker pull $ACR_LOGIN_SERVER/mywebapi:1.0.0
docker tag $ACR_LOGIN_SERVER/mywebapi:1.0.0 mywebapi:production

# Verify
docker images mywebapi
```

### Step 4: Pull Images on Remote Host

```bash
# SSH to remote host
ssh user@remote-host

# Login to ACR on remote host
az login
az acr login --name progressacr12345678

# Pull image
docker pull progressacr12345678.azurecr.io/mywebapi:1.0.0

# Run container
docker run -d -p 8080:8080 progressacr12345678.azurecr.io/mywebapi:1.0.0
```

---

## Lab 6: Running Containers from ACR Images

### Step 1: Run Simple Container

```bash
# Run container from ACR
docker run -d \
  --name myapi-container \
  -p 8080:8080 \
  $ACR_LOGIN_SERVER/mywebapi:1.0.0

# Verify container running
docker ps | grep myapi-container

# Test application
curl http://localhost:8080/api/health
```

### Step 2: Run with Environment Variables

```bash
# Run with configuration
docker run -d \
  --name myapi-prod \
  -p 8080:8080 \
  -e ASPNETCORE_ENVIRONMENT=Production \
  -e ConnectionStrings__DefaultConnection="Server=db.example.com;Database=MyDb;User=sa;Password=Pass123!" \
  $ACR_LOGIN_SERVER/mywebapi:1.0.0

# View logs
docker logs myapi-prod

# View environment variables
docker exec myapi-prod env | grep ASPNETCORE
```

### Step 3: Run with Volume Mounts

```bash
# Create volume for data persistence
docker volume create myapi-data

# Run with volume
docker run -d \
  --name myapi-persistent \
  -p 8080:8080 \
  -v myapi-data:/app/data \
  $ACR_LOGIN_SERVER/mywebapi:1.0.0

# Verify volume
docker volume inspect myapi-data
```

### Step 4: Run with Docker Compose

Create `docker-compose.yml`:

```yaml
version: '3.8'

services:
  api:
    image: progressacr12345678.azurecr.io/mywebapi:1.0.0
    ports:
      - "8080:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__DefaultConnection=Server=db;Database=MyDb;User=sa;Password=YourStrong@Passw0rd
    depends_on:
      - db
    networks:
      - mynetwork

  db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=YourStrong@Passw0rd
    ports:
      - "1433:1433"
    volumes:
      - sqldata:/var/opt/mssql
    networks:
      - mynetwork

volumes:
  sqldata:

networks:
  mynetwork:
```

Run with Docker Compose:

```bash
# Login to ACR first
az acr login --name progressacr12345678

# Start services
docker-compose up -d

# View logs
docker-compose logs -f api

# Stop services
docker-compose down
```

---

## Lab 7: Image Lifecycle Management

### Step 1: Delete Specific Tag

```bash
# Delete single tag
az acr repository delete \
  --name $ACR_NAME \
  --image mywebapi:build-123 \
  --yes

# Verify deletion
az acr repository show-tags --name $ACR_NAME --repository mywebapi --output table
```

**⚠️ Warning:** This permanently deletes the tag. Use with caution in production.

### Step 2: Delete Untagged Manifests

```bash
# Find untagged manifests
az acr repository show-manifests \
  --name $ACR_NAME \
  --repository mywebapi \
  --query "[?tags[0]==null].digest" \
  --output tsv

# Delete untagged manifests
UNTAGGED=$(az acr repository show-manifests \
  --name $ACR_NAME \
  --repository mywebapi \
  --query "[?tags[0]==null].digest" \
  --output tsv)

for digest in $UNTAGGED; do
  az acr repository delete \
    --name $ACR_NAME \
    --image mywebapi@$digest \
    --yes
done
```

### Step 3: Purge Old Images (Premium Only)

```bash
# Purge images older than 30 days
az acr run \
  --registry $ACR_NAME \
  --cmd "acr purge --filter 'mywebapi:.*' --ago 30d --untagged" \
  /dev/null

# Purge with dry-run (preview what would be deleted)
az acr run \
  --registry $ACR_NAME \
  --cmd "acr purge --filter 'mywebapi:.*' --ago 30d --dry-run" \
  /dev/null

# Purge keeping last N versions
az acr run \
  --registry $ACR_NAME \
  --cmd "acr purge --filter 'mywebapi:.*' --keep 5 --untagged" \
  /dev/null
```

### Step 4: Automated Retention Policy

Create ACR Task for automatic cleanup:

```bash
# Create scheduled task to run daily
az acr task create \
  --name cleanup-old-images \
  --registry $ACR_NAME \
  --cmd "acr purge --filter 'mywebapi:.*' --ago 90d --untagged" \
  --schedule "0 2 * * *" \
  --context /dev/null

# List scheduled tasks
az acr task list --registry $ACR_NAME --output table

# View task runs
az acr task list-runs --registry $ACR_NAME --name cleanup-old-images
```

### Step 5: Delete Entire Repository

```bash
# Delete repository and all tags
az acr repository delete \
  --name $ACR_NAME \
  --repository mywebapi \
  --yes

# Verify deletion
az acr repository list --name $ACR_NAME --output table
```

---

## Lab 8: Content Trust Configuration (Premium Only)

Content Trust ensures image integrity through cryptographic signing.

### Step 1: Enable Content Trust

```bash
# Enable content trust on ACR
az acr config content-trust update \
  --registry $ACR_NAME \
  --status enabled

# Verify status
az acr config content-trust show --registry $ACR_NAME
```

### Step 2: Configure Docker Content Trust

```bash
# Enable Docker Content Trust locally
export DOCKER_CONTENT_TRUST=1

# Set Notary server
export DOCKER_CONTENT_TRUST_SERVER=https://$ACR_NAME.azurecr.io

# Push signed image
docker push $ACR_LOGIN_SERVER/mywebapi:signed-v1.0.0
```

**First-time signing:**
- You'll be prompted to create signing keys
- Set passphrases for root and repository keys
- Store keys securely

### Step 3: Verify Signed Images

```bash
# Enable content trust for pull
export DOCKER_CONTENT_TRUST=1

# Pull will verify signature
docker pull $ACR_LOGIN_SERVER/mywebapi:signed-v1.0.0

# Pull unsigned image will fail
docker pull $ACR_LOGIN_SERVER/mywebapi:unsigned-tag
```

**Expected Output (on failure):**
```
Error: remote trust data does not exist for progressacr12345678.azurecr.io/mywebapi:
unsigned-tag: notary.progressacr12345678.azurecr.io does not have trust data for
progressacr12345678.azurecr.io/mywebapi
```

### Step 4: Manage Trust Keys

```bash
# List trusted repositories
docker trust inspect $ACR_LOGIN_SERVER/mywebapi:signed-v1.0.0

# Rotate signing keys
docker trust key generate mykey

# Add signer to repository
docker trust signer add --key mykey.pub mysigner $ACR_LOGIN_SERVER/mywebapi
```

### Step 5: Disable Content Trust

```bash
# Temporarily disable for development
export DOCKER_CONTENT_TRUST=0

# Or unset
unset DOCKER_CONTENT_TRUST

# Disable on ACR
az acr config content-trust update \
  --registry $ACR_NAME \
  --status disabled
```

---

## Verification and Testing

### Complete Image Management Script

```bash
#!/bin/bash

ACR_NAME="progressacr12345678"
ACR_LOGIN_SERVER="$ACR_NAME.azurecr.io"
IMAGE_NAME="mywebapi"

echo "=== ACR Image Management Verification ==="
echo ""

# Login to ACR
echo "1. Logging into ACR..."
az acr login --name $ACR_NAME
echo ""

# List repositories
echo "2. Repositories in ACR:"
az acr repository list --name $ACR_NAME --output table
echo ""

# List tags
echo "3. Tags for $IMAGE_NAME:"
az acr repository show-tags --name $ACR_NAME --repository $IMAGE_NAME --output table
echo ""

# Get repository size
echo "4. Repository Size:"
az acr repository show \
  --name $ACR_NAME \
  --repository $IMAGE_NAME \
  --query "{Repository:name, TagCount:tagCount}" \
  --output table
echo ""

# Test pull
echo "5. Testing Image Pull:"
docker pull $ACR_LOGIN_SERVER/$IMAGE_NAME:latest
if [ $? -eq 0 ]; then
    echo "   ✓ Successfully pulled image"
else
    echo "   ✗ Failed to pull image"
fi
echo ""

echo "=== Verification Complete ==="
```

---

## Troubleshooting

### Issue: "unauthorized: authentication required"

**Solution:**
```bash
# Re-login to ACR
az acr login --name $ACR_NAME

# Verify Docker is running
docker info

# Check Azure credentials
az account show
```

### Issue: "denied: requested access to the resource is denied"

**Solution:**
```bash
# Check role assignment
az role assignment list --scope $(az acr show --name $ACR_NAME --query id --output tsv)

# Grant acrpush role to current user
az role assignment create \
  --assignee $(az ad signed-in-user show --query objectId --output tsv) \
  --scope $(az acr show --name $ACR_NAME --query id --output tsv) \
  --role acrpush
```

### Issue: "manifest unknown: manifest unknown"

**Solution:**
```bash
# Verify repository and tag exist
az acr repository show-tags --name $ACR_NAME --repository mywebapi

# Check for typos in repository name
az acr repository list --name $ACR_NAME
```

### Issue: Push is very slow

**Solution:**
```bash
# Check network connectivity
ping $ACR_NAME.azurecr.io

# Enable data endpoint (Premium SKU)
az acr update --name $ACR_NAME --data-endpoint-enabled true

# Consider upgrading to Premium for better throughput
az acr update --name $ACR_NAME --sku Premium
```

---

## Best Practices

### Tagging Strategy
- ✅ Use semantic versioning (1.0.0, 1.0.1, etc.)
- ✅ Include git commit SHA for traceability
- ✅ Tag with environment (dev, staging, prod)
- ✅ Use immutable tags for production (avoid overwriting)
- ❌ Don't rely solely on `latest` tag in production
- ❌ Don't use generic tags like `prod` (use versioned tags)

### Image Management
- Implement image retention policies
- Regularly purge old/unused images
- Monitor repository sizes
- Use ACR Tasks for automated cleanup
- Document image lifecycle

### Security
- Enable content trust for critical images
- Sign all production images
- Use repository-scoped tokens (Premium)
- Implement image scanning
- Audit pull/push operations

### Performance
- Use appropriate ACR SKU for workload
- Enable geo-replication for global distribution
- Leverage layer caching during builds
- Use multi-stage builds to reduce image size

---

## Next Steps

You've mastered image management in ACR! Next:
- **Lab 3.4**: Work with OCI artifacts using ORAS
- **Lab 3.5**: Implement ACR security controls

---

## Additional Resources

- [ACR Authentication Overview](https://docs.microsoft.com/azure/container-registry/container-registry-authentication)
- [ACR Image Storage](https://docs.microsoft.com/azure/container-registry/container-registry-storage)
- [Content Trust in ACR](https://docs.microsoft.com/azure/container-registry/container-registry-content-trust)
- [ACR Tasks for Image Maintenance](https://docs.microsoft.com/azure/container-registry/container-registry-tasks-overview)
- [Docker Content Trust](https://docs.docker.com/engine/security/trust/)

---

**Progress Software** | Module 3: Azure Container Registry | Lab 3.3
