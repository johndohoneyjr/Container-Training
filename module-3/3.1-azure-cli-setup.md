# 3.1 Azure CLI and ORAS Setup

## Overview

This lab guides you through setting up the essential command-line tools needed for working with Azure Container Registry (ACR). You'll install Azure CLI for Azure resource management and ORAS CLI for OCI artifact operations.

## Learning Objectives

* Install and configure Azure CLI on your operating system
* Authenticate to Azure using az login
* Manage Azure subscriptions
* Install and configure ORAS CLI for ACR integration
* Verify tool installations and connectivity

## Prerequisites

* An Azure account with an active subscription
* Administrator/sudo privileges on your local machine
* Internet connectivity
* Terminal/command prompt access

- - -

## Lab 1: Installing Azure CLI

### Windows Installation

#### Option 1: MSI Installer (Recommended)

1. Download the Azure CLI installer from Microsoft:

```
https://aka.ms/installazurecliwindows
```

2. Run the installer and follow the setup wizard
3. Open a new Command Prompt or PowerShell window
4. Verify installation:

``` bash
az --version
```

#### Option 2: Windows Package Manager (winget)

``` bash
# Install using winget
winget install -e --id Microsoft.AzureCLI

# Verify installation
az --version
```

#### Option 3: Chocolatey

``` bash
# Install using Chocolatey
choco install azure-cli

# Verify installation
az --version
```

### macOS Installation

#### Using Homebrew (Recommended)

``` bash
# Update Homebrew
brew update

# Install Azure CLI
brew install azure-cli

# Verify installation
az --version
```

**Expected Output:**

```
azure-cli                         2.56.0

core                              2.56.0
telemetry                          1.1.0

Dependencies:
msal                            1.26.0
azure-mgmt-resource             23.1.0b2
...
```

### Linux Installation

#### Ubuntu/Debian

``` bash
# Get packages needed for install
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

# Verify installation
az --version
```

#### RHEL/CentOS/Fedora

``` bash
# Import Microsoft repository key
sudo rpm --import https://packages.microsoft.com/keys/microsoft.asc

# Add Azure CLI repository
echo -e "[azure-cli]
name=Azure CLI
baseurl=https://packages.microsoft.com/yumrepos/azure-cli
enabled=1
gpgcheck=1
gpgkey=https://packages.microsoft.com/keys/microsoft.asc" | sudo tee /etc/yum.repos.d/azure-cli.repo

# Install Azure CLI
sudo dnf install azure-cli

# Verify installation
az --version
```

#### Generic Linux (Install Script)

``` bash
# Download and run install script
curl -L https://aka.ms/InstallAzureCli | bash

# Verify installation
az --version
```

- - -

## Lab 2: Azure Authentication and Subscription Management

### Step 1: Login to Azure

``` bash
# Interactive login (opens browser)
az login
```

**What happens:**

* A browser window opens
* You authenticate with your Azure credentials
* The CLI displays available subscriptions

**Expected Output:**

``` json
[
  {
    "cloudName": "AzureCloud",
    "homeTenantId": "12345678-1234-1234-1234-123456789012",
    "id": "abcd1234-abcd-1234-abcd-123456789012",
    "isDefault": true,
    "managedByTenants": [],
    "name": "Visual Studio Enterprise Subscription",
    "state": "Enabled",
    "tenantId": "12345678-1234-1234-1234-123456789012",
    "user": {
      "name": "user@example.com",
      "type": "user"
    }
  }
]
```

### Step 2: Login with Service Principal (Optional)

For automation and CI/CD pipelines:

``` bash
# Login with service principal
az login --service-principal \
  --username <app-id> \
  --password <password-or-cert> \
  --tenant <tenant-id>
```

### Step 3: List Available Subscriptions

``` bash
# List all subscriptions
az account list --output table
```

**Expected Output:**

```
Name                                  CloudName    SubscriptionId                        State    IsDefault
------------------------------------  -----------  ------------------------------------  -------  -----------
Visual Studio Enterprise Subscription AzureCloud   abcd1234-abcd-1234-abcd-123456789012  Enabled  True
Pay-As-You-Go                        AzureCloud   efgh5678-efgh-5678-efgh-567890123456  Enabled  False
```

### Step 4: Set Active Subscription

``` bash
# Set subscription by name
az account set --subscription "Visual Studio Enterprise Subscription"

# OR set by subscription ID
az account set --subscription "abcd1234-abcd-1234-abcd-123456789012"

# Verify active subscription
az account show --output table
```

**Expected Output:**

```
EnvironmentName    HomeTenantId                          IsDefault    Name                                  State    TenantId
-----------------  ------------------------------------  -----------  ------------------------------------  -------  ------------------------------------
AzureCloud         12345678-1234-1234-1234-123456789012  True         Visual Studio Enterprise Subscription Enabled  12345678-1234-1234-1234-123456789012
```

### Step 5: Get Subscription Details

``` bash
# Show current subscription details (JSON)
az account show

# Show specific property
az account show --query "name" --output tsv

# Get subscription ID
az account show --query "id" --output tsv
```

- - -

## Lab 3: Installing ORAS CLI

ORAS (OCI Registry As Storage) is the CLI for working with OCI artifacts in container registries.

### Windows Installation

``` bash
# Download latest release for Windows
# Visit: https://github.com/oras-project/oras/releases

# Extract to a directory in PATH (e.g., C:\Tools)
# Or use Scoop package manager:
scoop install oras

# Verify installation
oras version
```

### macOS Installation

``` bash
# Install using Homebrew
brew install oras

# Verify installation
oras version
```

**Expected Output:**

```
Version:        1.1.0
Go version:     go1.21.5
Git commit:     abc123def
Git tree state: clean
```

### Linux Installation

``` bash
# Set ORAS version
VERSION="1.1.0"

# Download ORAS binary
curl -LO "https://github.com/oras-project/oras/releases/download/v${VERSION}/oras_${VERSION}_linux_amd64.tar.gz"

# Extract binary
mkdir -p oras-install/
tar -zxf oras_${VERSION}_*.tar.gz -C oras-install/

# Move to PATH
sudo mv oras-install/oras /usr/local/bin/

# Verify installation
oras version

# Clean up
rm -rf oras_${VERSION}_*.tar.gz oras-install/
```

### Verify ORAS Installation

``` bash
# Check version
oras version

# View help
oras --help

# View push command help
oras push --help
```

- - -

## Lab 4: Configuring ORAS for ACR Integration

### Prerequisites

* Azure CLI installed and authenticated
* Azure Container Registry created (you'll create one in the next lab)

### Step 1: Configure ORAS Authentication

ORAS can authenticate to ACR using Azure CLI credentials:

``` bash
# Login to Azure (if not already logged in)
az login

# Login to ACR using Azure CLI
# Replace 'myregistry' with your ACR name
az acr login --name myregistry
```

**Expected Output:**

```
Login Succeeded
```

### Step 2: Test ORAS Connectivity

``` bash
# Set environment variable for convenience
export REGISTRY="myregistry.azurecr.io"

# Test connection by listing repositories (will be empty initially)
oras repo tags $REGISTRY/test-repo
```

**⚠️ Note:** You'll get an error if the repository doesn't exist yet. This is expected.

### Step 3: Alternative Authentication Methods

#### Option A: Using ACR Admin Credentials

``` bash
# Get ACR credentials (admin must be enabled)
az acr credential show --name myregistry

# Login with username/password
oras login myregistry.azurecr.io \
  --username <username> \
  --password <password>
```

**⚠️ Security Warning:** Admin credentials should only be used for testing. Use service principals or managed identities in production.

#### Option B: Using Service Principal

``` bash
# Create service principal (you'll learn this in detail in lab 3.5)
SP_NAME="acr-oras-sp"
ACR_REGISTRY_ID=$(az acr show --name myregistry --query id --output tsv)

SP_PASSWD=$(az ad sp create-for-rbac \
  --name $SP_NAME \
  --scopes $ACR_REGISTRY_ID \
  --role acrpull \
  --query password \
  --output tsv)

SP_APP_ID=$(az ad sp list --display-name $SP_NAME --query [].appId --output tsv)

# Login with service principal
oras login myregistry.azurecr.io \
  --username $SP_APP_ID \
  --password $SP_PASSWD
```

- - -

## Lab 5: Verification and Testing

### Complete Verification Script

Create a verification script to test all installations:

``` bash
#!/bin/bash

echo "=== Azure CLI and ORAS Verification ==="
echo ""

# Check Azure CLI
echo "1. Azure CLI Version:"
az --version | head -n 1
if [ $? -eq 0 ]; then
    echo "   ✓ Azure CLI is installed"
else
    echo "   ✗ Azure CLI is NOT installed"
fi
echo ""

# Check authentication
echo "2. Azure Authentication:"
az account show --query "name" --output tsv 2>/dev/null
if [ $? -eq 0 ]; then
    echo "   ✓ Authenticated to Azure"
    echo "   Subscription: $(az account show --query name -o tsv)"
else
    echo "   ✗ Not authenticated. Run 'az login'"
fi
echo ""

# Check ORAS CLI
echo "3. ORAS CLI Version:"
oras version 2>/dev/null | head -n 1
if [ $? -eq 0 ]; then
    echo "   ✓ ORAS CLI is installed"
else
    echo "   ✗ ORAS CLI is NOT installed"
fi
echo ""

# Check Docker (optional, for next labs)
echo "4. Docker (Optional):"
docker --version 2>/dev/null
if [ $? -eq 0 ]; then
    echo "   ✓ Docker is installed"
else
    echo "   ⚠ Docker not found (needed for image operations)"
fi
echo ""

echo "=== Verification Complete ==="
```

Save as `verify-tools.sh` and run:

``` bash
chmod +x verify-tools.sh
./verify-tools.sh
```

### Individual Verification Commands

``` bash
# Verify Azure CLI
az --version
az account show

# Verify ORAS
oras version
oras --help

# Test Azure connectivity
az group list --output table

# Test ACR connectivity (if ACR exists)
az acr list --output table
```

- - -

## Troubleshooting

### Issue: "az: command not found"

**Solution:**

* **Windows**: Restart terminal after installation
* **macOS/Linux**: Check PATH configuration:

``` bash
# Add to ~/.bashrc or ~/.zshrc
export PATH=$PATH:/usr/local/bin
source ~/.bashrc  # or ~/.zshrc
```

### Issue: "az login" browser doesn't open

**Solution:**

``` bash
# Use device code flow
az login --use-device-code

# Follow the instructions to authenticate
```

### Issue: ORAS "command not found"

**Solution:**

``` bash
# Verify ORAS is in PATH
which oras

# If not found, add to PATH
export PATH=$PATH:/path/to/oras

# Make permanent by adding to ~/.bashrc or ~/.zshrc
```

### Issue: "No subscriptions found"

**Solution:**

* Verify you have an active Azure subscription
* Check with Azure Portal
* Contact your Azure administrator for subscription access

### Issue: ACR login fails

**Solution:**

``` bash
# Ensure you're logged into Azure
az login

# Try with explicit subscription
az account set --subscription "subscription-name"
az acr login --name myregistry

# Check ACR exists
az acr show --name myregistry --query "name"
```

- - -

## Best Practices

### Security

* ✅ Use `az login` for interactive sessions
* ✅ Use service principals for automation/CI/CD
* ✅ Rotate service principal credentials regularly
* ✅ Use managed identities when running on Azure resources
* ❌ Avoid storing credentials in scripts or environment variables

### Tool Management

* Keep Azure CLI updated: `az upgrade`
* Keep ORAS CLI updated: check releases periodically
* Use specific tool versions in CI/CD pipelines
* Document tool versions in project README

### Subscription Management

* Always verify active subscription before operations
* Use subscription names instead of IDs for clarity
* Tag resources appropriately for cost tracking
* Set up billing alerts

- - -

## Next Steps

Now that your environment is configured, you're ready to:

* **Lab 3.2**: Provision Azure Container Registry
* **Lab 3.3**: Push and pull container images
* **Lab 3.4**: Work with OCI artifacts using ORAS
* **Lab 3.5**: Implement ACR security controls

- - -

## Additional Resources

### Azure CLI Documentation

* [Azure CLI Overview](https://docs.microsoft.com/cli/azure/)
* [Azure CLI Reference](https://docs.microsoft.com/cli/azure/reference-index)
* [Azure CLI Installation Guide](https://docs.microsoft.com/cli/azure/install-azure-cli)

### ORAS Documentation

* [ORAS Project](https://oras.land/)
* [ORAS GitHub](https://github.com/oras-project/oras)
* [OCI Artifacts Specification](https://github.com/opencontainers/artifacts)

### Azure Container Registry

* [ACR Documentation](https://docs.microsoft.com/azure/container-registry/)
* [ACR Best Practices](https://docs.microsoft.com/azure/container-registry/container-registry-best-practices)

- - -

**Progress Software** \| Module 3: Azure Container Registry \| Lab 3\.1