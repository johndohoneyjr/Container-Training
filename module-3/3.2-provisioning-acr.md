# 3.2 Provisioning Azure Container Registry

## Overview
This lab guides you through creating and configuring Azure Container Registry (ACR) using both Azure CLI and the Azure Portal. You'll learn about ACR tiers, configuration options, and best practices for production deployments.

## Learning Objectives
- Understand ACR service tiers and features
- Provision ACR using Azure CLI
- Create ACR using Azure Portal
- Configure ACR settings and access
- Enable and manage admin credentials
- Understand geo-replication capabilities
- Introduction to ACR Tasks

## Prerequisites
- Azure CLI installed and configured (Lab 3.1)
- Active Azure subscription
- Resource group or permission to create one
- Basic understanding of container registries

---

## ACR Service Tiers Overview

### Feature Comparison

| Feature | Basic | Standard | Premium |
|---------|-------|----------|---------|
| **Storage** | 10 GB included | 100 GB included | 500 GB included |
| **Throughput** | Limited | Medium | High |
| **Webhooks** | 2 | 10 | 500 |
| **Geo-replication** | ‚ùå | ‚ùå | ‚úÖ |
| **Content Trust** | ‚ùå | ‚ùå | ‚úÖ |
| **Private Link** | ‚ùå | ‚ùå | ‚úÖ |
| **Customer-managed keys** | ‚ùå | ‚ùå | ‚úÖ |
| **Repository-scoped permissions** | ‚ùå | ‚ùå | ‚úÖ |
| **Availability Zones** | ‚ùå | ‚ùå | ‚úÖ |
| **Tasks** | ‚úÖ | ‚úÖ | ‚úÖ |
| **Price Point** | $ | $$ | $$$ |

### Choosing the Right Tier

**Basic**: 
- Development and testing
- Low-volume workloads
- Learning and experimentation
- Single-region deployments

**Standard**:
- Production workloads with moderate scale
- Need for webhooks
- Higher throughput requirements
- Most common choice for production

**Premium**:
- Enterprise production workloads
- Geo-replication for global distribution
- High-volume image operations
- Advanced security features (private endpoints, content trust)
- Compliance requirements
- High availability with availability zones

---

## Lab 1: Provisioning ACR with Azure CLI

### Step 1: Set Up Environment Variables

```bash
# Define variables for reusability
RESOURCE_GROUP="rg-containers-demo"
LOCATION="eastus"
ACR_NAME="progressacr$(date +%s)"  # Must be globally unique
SKU="Standard"  # or Basic, Premium

# Display variables
echo "Resource Group: $RESOURCE_GROUP"
echo "Location: $LOCATION"
echo "ACR Name: $ACR_NAME"
echo "SKU: $SKU"
```

**üí° Tip:** ACR names must be globally unique, lowercase letters and numbers only, 5-50 characters.

### Step 2: Create Resource Group

```bash
# Create resource group
az group create \
  --name $RESOURCE_GROUP \
  --location $LOCATION

# Verify creation
az group show --name $RESOURCE_GROUP --output table
```

**Expected Output:**
```
Location    Name
----------  ---------------------
eastus      rg-containers-demo
```

### Step 3: Create Azure Container Registry

```bash
# Create ACR
az acr create \
  --resource-group $RESOURCE_GROUP \
  --name $ACR_NAME \
  --sku $SKU \
  --location $LOCATION

# View ACR details
az acr show --name $ACR_NAME --output table
```

**Expected Output:**
```
NAME                 RESOURCE GROUP          LOCATION    SKU       LOGIN SERVER
-------------------  ----------------------  ----------  --------  --------------------------
progressacr12345678  rg-containers-demo      eastus      Standard  progressacr12345678.azurecr.io
```

### Step 4: Create Premium ACR with Advanced Features

For production deployments requiring geo-replication:

```bash
# Premium ACR with availability zones
ACR_NAME_PREMIUM="progressacrprem$(date +%s)"

az acr create \
  --resource-group $RESOURCE_GROUP \
  --name $ACR_NAME_PREMIUM \
  --sku Premium \
  --location $LOCATION \
  --zone-redundancy Enabled

# Verify creation
az acr show --name $ACR_NAME_PREMIUM --query "{Name:name, Sku:sku.name, ZoneRedundancy:zoneRedundancy}" --output table
```

### Step 5: Configure ACR Settings

```bash
# Enable anonymous pull (public access to images)
az acr update --name $ACR_NAME --anonymous-pull-enabled true

# Enable data endpoint (for direct registry access)
az acr update --name $ACR_NAME --data-endpoint-enabled true

# Disable public network access (Premium only - be careful!)
# az acr update --name $ACR_NAME_PREMIUM --public-network-enabled false

# Add tags for organization
az acr update --name $ACR_NAME \
  --tags Environment=Development Project=ContainerTraining Owner=DevOps
```

### Step 6: Enable Admin User (Development Only)

```bash
# Enable admin account
az acr update --name $ACR_NAME --admin-enabled true

# Get admin credentials
az acr credential show --name $ACR_NAME --output table
```

**Expected Output:**
```
USERNAME              PASSWORD                          PASSWORD2
--------------------  --------------------------------  --------------------------------
progressacr12345678   XyZ+aB/cD1234567890qWErT...      pQr/sT2345678901uVwXy...
```

**‚ö†Ô∏è Security Warning:** 
- Admin credentials provide full registry access
- Use only for development/testing
- For production, use:
  - Azure Active Directory service principals
  - Managed identities
  - Repository-scoped tokens (Premium)

---

## Lab 2: Creating ACR via Azure Portal

### Step 1: Navigate to Azure Portal

1. Open browser and go to: [https://portal.azure.com](https://portal.azure.com)
2. Sign in with your Azure credentials
3. Click **"Create a resource"** in the left menu

### Step 2: Search and Select Container Registry

1. In the search box, type: **"Container Registry"**
2. Select **"Container Registry"** from results
3. Click **"Create"** button

### Step 3: Configure Basic Settings

**Basics Tab:**

| Field | Value | Notes |
|-------|-------|-------|
| Subscription | Select your subscription | |
| Resource Group | rg-containers-demo | Create new or use existing |
| Registry Name | progressacrportal | Must be globally unique |
| Location | East US | Choose closest region |
| SKU | Standard | Select appropriate tier |

### Step 4: Configure Networking (Optional)

**Networking Tab:**

For Premium tier only:
- **Public Access**: 
  - ‚úÖ All networks (default)
  - ‚ö™ Selected networks (firewall rules)
  - ‚ö™ Disabled (private endpoint only)

**Private Endpoint** (Premium):
- Click **"Add private endpoint"** for secure VNet access
- Configure virtual network and subnet
- Select private DNS integration

### Step 5: Configure Encryption (Premium Only)

**Encryption Tab:**

- **Identity**: Choose managed identity for key access
- **Customer-managed key**: 
  - Select Azure Key Vault
  - Choose encryption key
  - Useful for compliance requirements

### Step 6: Add Tags

**Tags Tab:**

Add organizational tags:
```
Environment: Development
Project: ContainerTraining
Owner: DevOps
CostCenter: IT-12345
```

### Step 7: Review and Create

1. Click **"Review + create"**
2. Review all settings
3. Click **"Create"** to deploy
4. Wait for deployment (typically 1-2 minutes)
5. Click **"Go to resource"** when complete

### Step 8: Explore ACR in Portal

Navigate through:
- **Overview**: Dashboard, essentials, activity
- **Repositories**: Container image repositories (empty initially)
- **Access keys**: Admin credentials (if enabled)
- **Networking**: Firewall and private endpoint settings
- **Replications**: Geo-replication configuration (Premium)
- **Webhooks**: Event notifications
- **Tasks**: Automated build tasks
- **Tokens**: Repository-scoped access (Premium)

---

## Lab 3: Configuring ACR Settings

### Managing Admin Credentials

```bash
# Check if admin is enabled
az acr show --name $ACR_NAME --query "adminUserEnabled"

# Get admin credentials
az acr credential show --name $ACR_NAME

# Regenerate password (rotate credentials)
az acr credential renew --name $ACR_NAME --password-name password

# Regenerate alternate password
az acr credential renew --name $ACR_NAME --password-name password2

# Disable admin user (recommended for production)
az acr update --name $ACR_NAME --admin-enabled false
```

### Configuring Anonymous Pull

Allow public access to images without authentication:

```bash
# Enable anonymous pull
az acr update --name $ACR_NAME --anonymous-pull-enabled true

# Test anonymous pull (after pushing an image)
docker pull $ACR_NAME.azurecr.io/myapp:latest
```

**‚ö†Ô∏è Security Note:** Only enable for truly public images. Consider implications for:
- Internal/proprietary applications
- Compliance requirements
- Bandwidth costs

### Configuring Webhooks

Set up notifications for registry events:

```bash
# Create webhook
az acr webhook create \
  --registry $ACR_NAME \
  --name mywebhook \
  --uri https://myapp.example.com/webhook \
  --actions push delete \
  --scope myapp:*

# List webhooks
az acr webhook list --registry $ACR_NAME --output table

# Test webhook
az acr webhook ping --registry $ACR_NAME --name mywebhook

# View webhook events
az acr webhook list-events --registry $ACR_NAME --name mywebhook
```

---

## Lab 4: Geo-Replication (Premium Only)

Geo-replication provides:
- Global distribution of images
- Reduced latency for distributed teams
- High availability across regions
- Network-close registry access

### Step 1: Create Replication

```bash
# Ensure you have Premium SKU
ACR_NAME_PREMIUM="progressacrprem$(date +%s)"

# Create Premium ACR
az acr create \
  --resource-group $RESOURCE_GROUP \
  --name $ACR_NAME_PREMIUM \
  --sku Premium \
  --location eastus

# Add replications to other regions
az acr replication create \
  --registry $ACR_NAME_PREMIUM \
  --location westus2

az acr replication create \
  --registry $ACR_NAME_PREMIUM \
  --location northeurope

# List replications
az acr replication list --registry $ACR_NAME_PREMIUM --output table
```

**Expected Output:**
```
NAME         LOCATION      PROVISIONING STATE    STATUS
-----------  ------------  --------------------  --------
eastus       eastus        Succeeded             Ready
westus2      westus2       Succeeded             Ready
northeurope  northeurope   Succeeded             Ready
```

### Step 2: Test Geo-Replication

```bash
# Push image (will replicate automatically)
docker tag myapp:latest $ACR_NAME_PREMIUM.azurecr.io/myapp:latest
docker push $ACR_NAME_PREMIUM.azurecr.io/myapp:latest

# Pull from different regions (automatic routing to nearest replica)
# Clients automatically connect to closest replica
docker pull $ACR_NAME_PREMIUM.azurecr.io/myapp:latest
```

### Step 3: Remove Replication

```bash
# Remove a replication
az acr replication delete \
  --registry $ACR_NAME_PREMIUM \
  --name northeurope

# Verify removal
az acr replication list --registry $ACR_NAME_PREMIUM --output table
```

---

## Lab 5: Introduction to ACR Tasks

ACR Tasks enable cloud-based container image building without local Docker daemon.

### Understanding ACR Tasks

**Use Cases:**
- Automated builds on source code commit
- Multi-step task workflows
- Base image update automation
- Scheduled tasks
- Security scanning

### Quick Task Example

```bash
# Build image in ACR (no local Docker needed)
az acr build \
  --registry $ACR_NAME \
  --image myapp:{{.Run.ID}} \
  --image myapp:latest \
  --file Dockerfile \
  https://github.com/Azure-Samples/dotnet-core-api.git

# List tasks
az acr task list --registry $ACR_NAME --output table

# View task run history
az acr task list-runs --registry $ACR_NAME --output table
```

### Creating Automated Build Task

```bash
# Create task that triggers on git commit
az acr task create \
  --registry $ACR_NAME \
  --name build-myapp \
  --image myapp:{{.Run.ID}} \
  --context https://github.com/youruser/yourrepo.git \
  --file Dockerfile \
  --git-access-token <github-token> \
  --commit-trigger-enabled true

# Manually run task
az acr task run --registry $ACR_NAME --name build-myapp

# View task details
az acr task show --registry $ACR_NAME --name build-myapp
```

**üí° Benefits:**
- No local Docker installation required
- Automated builds on code changes
- Consistent build environment
- Integrated with Azure DevOps and GitHub Actions

---

## Verification and Testing

### Complete Verification Script

```bash
#!/bin/bash

ACR_NAME="your-acr-name"

echo "=== ACR Verification ==="
echo ""

# Check ACR exists
echo "1. ACR Status:"
az acr show --name $ACR_NAME --query "{Name:name, Status:provisioningState, SKU:sku.name, LoginServer:loginServer}" --output table
echo ""

# Check admin status
echo "2. Admin User:"
ADMIN_ENABLED=$(az acr show --name $ACR_NAME --query "adminUserEnabled" --output tsv)
if [ "$ADMIN_ENABLED" == "true" ]; then
    echo "   ‚ö† Admin user is enabled (not recommended for production)"
else
    echo "   ‚úì Admin user is disabled"
fi
echo ""

# Check replications (Premium only)
echo "3. Replications:"
az acr replication list --registry $ACR_NAME --output table 2>/dev/null || echo "   N/A (requires Premium SKU)"
echo ""

# Check webhooks
echo "4. Webhooks:"
WEBHOOK_COUNT=$(az acr webhook list --registry $ACR_NAME --query "length(@)" --output tsv)
echo "   Configured webhooks: $WEBHOOK_COUNT"
echo ""

# Test connectivity
echo "5. Connectivity Test:"
az acr login --name $ACR_NAME
if [ $? -eq 0 ]; then
    echo "   ‚úì Successfully connected to ACR"
else
    echo "   ‚úó Failed to connect to ACR"
fi
echo ""

echo "=== Verification Complete ==="
```

---

## Troubleshooting

### Issue: ACR name already exists

**Solution:**
```bash
# Check if name is available
az acr check-name --name myregistryname

# Use unique suffix
ACR_NAME="myacr$(date +%s)"
```

### Issue: "Resource provider not registered"

**Solution:**
```bash
# Register Microsoft.ContainerRegistry provider
az provider register --namespace Microsoft.ContainerRegistry

# Check registration status
az provider show --namespace Microsoft.ContainerRegistry --query "registrationState"
```

### Issue: Cannot login to ACR

**Solution:**
```bash
# Verify Azure login
az account show

# Check ACR exists
az acr show --name $ACR_NAME

# Try explicit login
az acr login --name $ACR_NAME

# Check Docker is running
docker info
```

### Issue: Geo-replication not available

**Error:** "Geo-replication is only available for Premium SKU"

**Solution:**
```bash
# Upgrade to Premium
az acr update --name $ACR_NAME --sku Premium
```

---

## Best Practices

### Security
- ‚úÖ Disable admin user in production
- ‚úÖ Use Azure AD service principals or managed identities
- ‚úÖ Enable private endpoints for Premium registries
- ‚úÖ Implement repository-scoped tokens (Premium)
- ‚úÖ Enable content trust for image signing (Premium)
- ‚úÖ Use network restrictions and firewall rules
- ‚ùå Never commit admin credentials to source control

### Performance
- Use Premium SKU for production workloads
- Enable geo-replication for global deployments
- Use data endpoints for improved throughput
- Implement image retention policies
- Monitor webhook activity

### Cost Optimization
- Start with Basic/Standard for development
- Upgrade to Premium only when needed
- Clean up unused images regularly
- Monitor storage usage
- Use Azure Cost Management

### Operations
- Tag ACR resources appropriately
- Use consistent naming conventions
- Document ACR configuration
- Set up monitoring and alerts
- Plan for disaster recovery

---

## Cost Considerations

### Pricing Components
- **Registry units**: Base cost per tier
- **Storage**: Beyond included amount
- **Geo-replication**: Per replica location (Premium)
- **Build minutes**: ACR Tasks execution time
- **Data transfer**: Egress beyond free tier

### Example Pricing (Approximate)
- **Basic**: ~$5/month + storage
- **Standard**: ~$20/month + storage
- **Premium**: ~$75/month + storage + replicas

**üí° Tip:** Use [Azure Pricing Calculator](https://azure.microsoft.com/pricing/calculator/) for accurate estimates.

---

## Next Steps

You've successfully provisioned and configured ACR! Next:
- **Lab 3.3**: Push and pull container images
- **Lab 3.4**: Work with OCI artifacts using ORAS
- **Lab 3.5**: Implement security controls

---

## Additional Resources

- [ACR Pricing](https://azure.microsoft.com/pricing/details/container-registry/)
- [ACR Service Tiers](https://docs.microsoft.com/azure/container-registry/container-registry-skus)
- [ACR Tasks Documentation](https://docs.microsoft.com/azure/container-registry/container-registry-tasks-overview)
- [ACR Geo-replication](https://docs.microsoft.com/azure/container-registry/container-registry-geo-replication)
- [ACR Best Practices](https://docs.microsoft.com/azure/container-registry/container-registry-best-practices)

---

**Progress Software** | Module 3: Azure Container Registry | Lab 3.2
