# Lab 2.2: Understanding .NET Container Images

## Overview
In this lab, you'll explore the .NET container image ecosystem. You'll learn about the Microsoft Container Registry (MCR), understand the hierarchy of .NET images, pull and inspect different image variants, and get introduced to Docker Hardened Images.

## Learning Objectives
- Understand Microsoft Container Registry (MCR) structure
- Differentiate between SDK, ASP.NET, Runtime, and Runtime-Deps images
- Compare Alpine vs Debian image variants
- Inspect image layers and sizes
- Explore Docker Hardened Images for enhanced security

## Prerequisites
- Docker Desktop installed and running
- Basic understanding of Docker commands
- Terminal/Command Prompt access

---

## Part 1: Microsoft Container Registry (MCR)

### What is MCR?

**Microsoft Container Registry** (mcr.microsoft.com) is Microsoft's public registry for official container images. It provides:
- Official Microsoft product images (.NET, SQL Server, PowerShell, etc.)
- High availability and global distribution
- No authentication required for public images
- Guaranteed authenticity and regular security updates

### Key .NET Image Repositories

| Repository | Purpose | When to Use |
|------------|---------|-------------|
| `mcr.microsoft.com/dotnet/sdk` | Development and building | Building .NET applications |
| `mcr.microsoft.com/dotnet/aspnet` | ASP.NET Core runtime | Running ASP.NET Core apps |
| `mcr.microsoft.com/dotnet/runtime` | .NET runtime only | Running console apps, workers |
| `mcr.microsoft.com/dotnet/runtime-deps` | OS dependencies only | Self-contained apps |

---

## Part 2: Exploring the .NET Image Hierarchy

### Lab Exercise 1: Pull and Inspect .NET SDK Image

The SDK image contains everything needed to develop .NET applications.

#### Step 1: Pull the .NET SDK Image

```bash
docker pull mcr.microsoft.com/dotnet/sdk:10.0
```

**Expected Output:**
```
8.0: Pulling from dotnet/sdk
e4fff0779e6d: Pull complete
...
Digest: sha256:a1b2c3d4...
Status: Downloaded newer image for mcr.microsoft.com/dotnet/sdk:10.0
```

#### Step 2: Inspect the Image

```bash
docker images mcr.microsoft.com/dotnet/sdk:10.0
```

**Expected Output:**
```
REPOSITORY                       TAG    IMAGE ID       CREATED       SIZE
mcr.microsoft.com/dotnet/sdk     8.0    a1b2c3d4e5f6   2 weeks ago   900MB
```

#### Step 3: View Image Details

```bash
docker inspect mcr.microsoft.com/dotnet/sdk:10.0
```

This shows detailed information including:
- Environment variables
- Exposed ports
- Default working directory
- Entry point
- Layer information

#### Step 4: Verify SDK Installation

```bash
docker run --rm mcr.microsoft.com/dotnet/sdk:10.0 dotnet --version
```

**Expected Output:**
```
8.0.1
```

#### Step 5: List Available SDKs and Runtimes

```bash
docker run --rm mcr.microsoft.com/dotnet/sdk:10.0 dotnet --list-sdks
docker run --rm mcr.microsoft.com/dotnet/sdk:10.0 dotnet --list-runtimes
```

**Expected Output:**
```
SDKs:
8.0.101 [/usr/share/dotnet/sdk]

Runtimes:
Microsoft.AspNetCore.App 8.0.1 [/usr/share/dotnet/shared/Microsoft.AspNetCore.App]
Microsoft.NETCore.App 8.0.1 [/usr/share/dotnet/shared/Microsoft.NETCore.App]
```

---

### Lab Exercise 2: Pull and Inspect ASP.NET Core Runtime Image

The ASP.NET image is optimized for running ASP.NET Core web applications.

#### Step 1: Pull the ASP.NET Image

```bash
docker pull mcr.microsoft.com/dotnet/aspnet:10.0
```

#### Step 2: Compare Image Sizes

```bash
docker images | grep dotnet
```

**Expected Output:**
```
mcr.microsoft.com/dotnet/sdk       8.0    a1b2c3d4e5f6   2 weeks ago   900MB
mcr.microsoft.com/dotnet/aspnet    8.0    b2c3d4e5f6a7   2 weeks ago   220MB
```

> **üìä Size Comparison**: Notice that the ASP.NET image is ~680MB smaller than the SDK image because it doesn't include build tools.

#### Step 3: Check Runtime Availability

```bash
docker run --rm mcr.microsoft.com/dotnet/aspnet:10.0 dotnet --list-runtimes
```

**Expected Output:**
```
Microsoft.AspNetCore.App 8.0.1 [/usr/share/dotnet/shared/Microsoft.AspNetCore.App]
Microsoft.NETCore.App 8.0.1 [/usr/share/dotnet/shared/Microsoft.NETCore.App]
```

---

### Lab Exercise 3: Pull and Inspect .NET Runtime Image

The runtime image is for non-web applications (console apps, workers).

#### Step 1: Pull the Runtime Image

```bash
docker pull mcr.microsoft.com/dotnet/runtime:10.0
```

#### Step 2: Compare All Image Sizes

```bash
docker images | grep "dotnet.*8.0"
```

**Expected Output:**
```
mcr.microsoft.com/dotnet/sdk       8.0    a1b2c3d4e5f6   2 weeks ago   900MB
mcr.microsoft.com/dotnet/aspnet    8.0    b2c3d4e5f6a7   2 weeks ago   220MB
mcr.microsoft.com/dotnet/runtime   8.0    c3d4e5f6a7b8   2 weeks ago   190MB
```

#### Step 3: Verify Runtime Only (No ASP.NET)

```bash
docker run --rm mcr.microsoft.com/dotnet/runtime:10.0 dotnet --list-runtimes
```

**Expected Output:**
```
Microsoft.NETCore.App 8.0.1 [/usr/share/dotnet/shared/Microsoft.NETCore.App]
```

> **‚ö†Ô∏è Note**: No ASP.NET runtime is included in this image.

---

### Lab Exercise 4: Explore Runtime-Deps Image

The runtime-deps image contains only OS-level dependencies needed for self-contained apps.

#### Step 1: Pull the Runtime-Deps Image

```bash
docker pull mcr.microsoft.com/dotnet/runtime-deps:10.0
```

#### Step 2: Compare All Image Sizes

```bash
docker images | grep "dotnet.*8.0"
```

**Expected Output:**
```
mcr.microsoft.com/dotnet/sdk            8.0    a1b2c3d4e5f6   2 weeks ago   900MB
mcr.microsoft.com/dotnet/aspnet         8.0    b2c3d4e5f6a7   2 weeks ago   220MB
mcr.microsoft.com/dotnet/runtime        8.0    c3d4e5f6a7b8   2 weeks ago   190MB
mcr.microsoft.com/dotnet/runtime-deps   8.0    d4e5f6a7b8c9   2 weeks ago   120MB
```

#### Step 3: Verify No .NET Runtime

```bash
docker run --rm mcr.microsoft.com/dotnet/runtime-deps:10.0 dotnet --version
```

**Expected Output:**
```
/bin/sh: dotnet: not found
```

> **üí° Use Case**: This image is used for self-contained .NET apps that bundle the runtime.

---

## Part 3: Alpine vs Debian Variants

### Understanding Base Operating Systems

.NET images come in two main variants:

| Variant | Base OS | Size | Use Case |
|---------|---------|------|----------|
| **Debian** | Debian Linux | Larger | Better compatibility, more tools |
| **Alpine** | Alpine Linux | Smaller | Minimal footprint, security-focused |

### Lab Exercise 5: Compare Alpine and Debian Images

#### Step 1: Pull Both Variants

```bash
# Pull Debian variant (default)
docker pull mcr.microsoft.com/dotnet/aspnet:10.0

# Pull Alpine variant
docker pull mcr.microsoft.com/dotnet/aspnet:10.0-alpine
```

#### Step 2: Compare Image Sizes

```bash
docker images | grep "aspnet.*8.0"
```

**Expected Output:**
```
mcr.microsoft.com/dotnet/aspnet   8.0         b2c3d4e5f6a7   2 weeks ago   220MB
mcr.microsoft.com/dotnet/aspnet   8.0-alpine  e5f6a7b8c9d0   2 weeks ago   115MB
```

> **üìä Size Difference**: Alpine images are approximately 50% smaller!

#### Step 3: Explore Base OS

**Debian variant:**
```bash
docker run --rm mcr.microsoft.com/dotnet/aspnet:10.0 cat /etc/os-release
```

**Expected Output:**
```
PRETTY_NAME="Debian GNU/Linux 12 (bookworm)"
NAME="Debian GNU/Linux"
VERSION_ID="12"
VERSION="12 (bookworm)"
...
```

**Alpine variant:**
```bash
docker run --rm mcr.microsoft.com/dotnet/aspnet:10.0-alpine cat /etc/os-release
```

**Expected Output:**
```
NAME="Alpine Linux"
ID=alpine
VERSION_ID=3.18.4
PRETTY_NAME="Alpine Linux v3.18"
...
```

#### Step 4: Compare Available Tools

**Debian (bash available):**
```bash
docker run --rm -it mcr.microsoft.com/dotnet/aspnet:10.0 bash --version
```

**Alpine (only sh available):**
```bash
docker run --rm -it mcr.microsoft.com/dotnet/aspnet:10.0-alpine sh --version
```

### Alpine vs Debian: Pros and Cons

#### Alpine Advantages ‚úÖ
- **Smaller size**: Faster downloads and deployments
- **Security**: Minimal attack surface, fewer packages
- **Performance**: Lower memory footprint

#### Alpine Disadvantages ‚ö†Ô∏è
- Uses musl libc (not glibc): May have compatibility issues
- Fewer pre-installed tools
- Some native dependencies might not be available

#### When to Use Each

**Use Debian when:**
- You need maximum compatibility
- Using native dependencies (e.g., System.Drawing on Linux)
- Development and debugging (more tools available)

**Use Alpine when:**
- Minimizing image size is critical
- Security is a top priority
- Your app has no special native dependencies

---

## Part 4: Version Tagging Strategies

### Understanding .NET Version Tags

#### Step 1: View Available Tags

Visit: https://mcr.microsoft.com/v2/dotnet/aspnet/tags/list

Or use Docker Hub: https://hub.docker.com/_/microsoft-dotnet-aspnet

#### Common Tag Formats

```bash
# Major version (rolling, not recommended for production)
mcr.microsoft.com/dotnet/aspnet:10.0

# Specific patch version (recommended)
mcr.microsoft.com/dotnet/aspnet:10.0.1

# With OS variant
mcr.microsoft.com/dotnet/aspnet:10.0-alpine
mcr.microsoft.com/dotnet/aspnet:10.0-jammy

# Specific version with OS
mcr.microsoft.com/dotnet/aspnet:10.0.1-alpine3.18

# LTS (Long-Term Support) - .NET 6 and 8
mcr.microsoft.com/dotnet/aspnet:6.0
mcr.microsoft.com/dotnet/aspnet:10.0

# STS (Standard-Term Support) - .NET 7, 9
mcr.microsoft.com/dotnet/aspnet:7.0
```

### Lab Exercise 6: Pull Specific Version Tags

```bash
# Pull specific patch version
docker pull mcr.microsoft.com/dotnet/aspnet:10.0.1

# Pull Alpine variant with specific version
docker pull mcr.microsoft.com/dotnet/aspnet:10.0.1-alpine3.18

# Pull Debian variant (Ubuntu Jammy)
docker pull mcr.microsoft.com/dotnet/aspnet:10.0-jammy
```

### Best Practices for Production

‚úÖ **DO:**
- Use specific patch versions: `8.0.1`
- Specify OS variant: `8.0.1-alpine3.18`
- Pin to LTS versions for stability

‚ùå **DON'T:**
- Use `latest` tag in production
- Use major-only tags (e.g., `8.0`) unless you understand the implications
- Mix different base OS types in your deployment

---

## Part 5: Docker Hardened Images

### Introduction to Docker Hardened Images

**Docker Hardened Images** (dhia.io) are security-enhanced versions of official images with:
- CVE patching and regular security updates
- Reduced attack surface
- Security best practices applied
- Compliance with security standards

### Accessing Hardened Images

Hardened images are available at: `dhia.io/dotnet`

#### Available Hardened .NET Images

```bash
# ASP.NET Core runtime (hardened)
dhia.io/dotnet/aspnet:10.0-alpine

# .NET SDK (hardened)
dhia.io/dotnet/sdk:10.0-alpine

# .NET Runtime (hardened)
dhia.io/dotnet/runtime:10.0-alpine
```

### Lab Exercise 7: Explore Hardened Images

> **‚ö†Ô∏è Note**: Access to dhia.io may require authentication or a subscription.

#### Step 1: Compare Standard vs Hardened (Conceptual)

**Standard MCR Image:**
```bash
docker pull mcr.microsoft.com/dotnet/aspnet:10.0-alpine
docker scout cves mcr.microsoft.com/dotnet/aspnet:10.0-alpine
```

**Hardened Image (if accessible):**
```bash
# docker pull dhia.io/dotnet/aspnet:10.0-alpine
# docker scout cves dhia.io/dotnet/aspnet:10.0-alpine
```

#### Key Differences

| Feature | Standard MCR | Hardened Image |
|---------|--------------|----------------|
| CVE Patching | Regular updates | Accelerated patching |
| Security Hardening | Basic | Advanced |
| Compliance | Standard | Enhanced |
| Size | Optimized | Further optimized |
| Support | Community | Commercial (varies) |

---

## Part 6: Image Inspection Deep Dive

### Lab Exercise 8: Analyze Image Layers

#### Step 1: View Image History

```bash
docker history mcr.microsoft.com/dotnet/aspnet:10.0-alpine
```

**Expected Output:**
```
IMAGE          CREATED        CREATED BY                                      SIZE
e5f6a7b8c9d0   2 weeks ago    ENTRYPOINT ["dotnet"]                          0B
a7b8c9d0e1f2   2 weeks ago    COPY /usr/share/dotnet /usr/share/dotnet       70MB
b8c9d0e1f2a3   2 weeks ago    RUN apk add --no-cache ...                     15MB
...
```

#### Step 2: Inspect Layers in Detail

```bash
docker inspect mcr.microsoft.com/dotnet/aspnet:10.0-alpine --format='{{json .RootFS.Layers}}' | jq
```

#### Step 3: Use Dive Tool (Optional - Advanced)

Install `dive` to interactively explore image layers:

**macOS:**
```bash
brew install dive
```

**Ubuntu/Debian:**
```bash
wget https://github.com/wagoodman/dive/releases/download/v0.11.0/dive_0.11.0_linux_amd64.deb
sudo dpkg -i dive_0.11.0_linux_amd64.deb
```

**Run Dive:**
```bash
dive mcr.microsoft.com/dotnet/aspnet:10.0-alpine
```

---

## Part 7: Hands-On Practice

### Exercise: Create an Image Size Comparison Table

Pull the following images and create a comparison table:

```bash
# Pull all variants
docker pull mcr.microsoft.com/dotnet/sdk:10.0
docker pull mcr.microsoft.com/dotnet/sdk:10.0-alpine
docker pull mcr.microsoft.com/dotnet/aspnet:10.0
docker pull mcr.microsoft.com/dotnet/aspnet:10.0-alpine
docker pull mcr.microsoft.com/dotnet/runtime:10.0
docker pull mcr.microsoft.com/dotnet/runtime:10.0-alpine
docker pull mcr.microsoft.com/dotnet/runtime-deps:10.0
docker pull mcr.microsoft.com/dotnet/runtime-deps:10.0-alpine
```

View all images:
```bash
docker images | grep "dotnet.*8.0"
```

Create a table like this:

| Image Type | Debian Size | Alpine Size | Savings |
|------------|-------------|-------------|---------|
| SDK | 900MB | 700MB | 200MB (22%) |
| ASP.NET | 220MB | 115MB | 105MB (48%) |
| Runtime | 190MB | 95MB | 95MB (50%) |
| Runtime-Deps | 120MB | 45MB | 75MB (63%) |

---

## Part 8: Clean Up

After completing the lab, clean up unused images:

```bash
# Remove specific images
docker rmi mcr.microsoft.com/dotnet/sdk:10.0
docker rmi mcr.microsoft.com/dotnet/aspnet:10.0-alpine

# Or remove all .NET images
docker images | grep dotnet | awk '{print $3}' | xargs docker rmi

# Or use prune to remove unused images
docker image prune -a
```

---

## Summary

In this lab, you've learned:
- ‚úÖ The structure and purpose of Microsoft Container Registry (MCR)
- ‚úÖ Differences between SDK, ASP.NET, Runtime, and Runtime-Deps images
- ‚úÖ How to compare Alpine vs Debian variants
- ‚úÖ Version tagging strategies and best practices
- ‚úÖ Introduction to Docker Hardened Images
- ‚úÖ How to inspect and analyze image layers

---

## Quick Reference

### Image Selection Guide

**For Development:**
```
mcr.microsoft.com/dotnet/sdk:10.0
```

**For ASP.NET Core Production:**
```
mcr.microsoft.com/dotnet/aspnet:10.0.1-alpine
```

**For Console App/Worker Production:**
```
mcr.microsoft.com/dotnet/runtime:10.0.1-alpine
```

**For Self-Contained Apps:**
```
mcr.microsoft.com/dotnet/runtime-deps:10.0-alpine
```

---

## Next Steps

Now that you understand .NET container images, you're ready to create Dockerfiles!

**Ready to proceed to**: [Lab 2.3: Creating Dockerfiles for .NET Applications](2.3-creating-dockerfiles.md)

---

## Additional Resources

- [.NET Container Images - Official Documentation](https://hub.docker.com/_/microsoft-dotnet)
- [Microsoft Container Registry Catalog](https://mcr.microsoft.com/)
- [.NET on Docker - Best Practices](https://docs.docker.com/language/dotnet/)
- [Docker Image Specification](https://github.com/moby/moby/blob/master/image/spec/v1.2.md)

---

*Lab created by Progress Software for the .NET Containerization and Azure Deployment course.*
